{"version":3,"sources":["../src/index.js"],"names":["fs","require","path","glob","util","merge","obj1","obj2","c","keys","i","length","hasOwnProperty","rLayoutPattern","rPartialPattern","read","filename","resolve","reject","readFile","encoding","err","data","MissingTemplateError","message","extra","Error","captureStackTrace","constructor","name","inherits","BadOptionsError","exports","module","Hbs","create","handlebars","Utils","SafeString","prototype","configure","options","self","viewPath","templateOptions","extname","partialsPath","contentHelperName","blockHelperName","defaultLayout","layoutsPath","locals","cache","blocks","registerHelper","val","block","fn","content","middleware","hbs","registerPartials","ctx","next","render","tpl","theme","state","tplPath","getTemplatePath","partials","isAbsolute","rawTemplate","template","compile","partial","exec","push","layout","test","loadLayoutFile","rawLayout","layoutTemplate","getLayoutTemplate","koa","body","getLayoutPath","join","getLayout","console","error","stack","file","apply","arguments","registerPartial","readdir","root","cwd","files","resultList","names","forEach","result","slice","key","pathCache","statSync","e","context"],"mappings":"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","file":"index.js","sourcesContent":["var fs = require('fs');\nvar path = require('path');\nvar glob = require('glob');\nvar util = require('util');\n\n/**\n * Shallow copy two objects into a new object\n *\n * Objects are merged from left to right. Thus, properties in objects further\n * to the right are preferred over those on the left.\n *\n * @param {object} obj1\n * @param {object} obj2\n * @returns {object}\n * @api private\n */\n\nvar merge = function (obj1, obj2) {\n    var c = {};\n    var keys = Object.keys(obj2);\n    for (var i = 0; i !== keys.length; i++) {\n        c[keys[i]] = obj2[keys[i]];\n    }\n\n    keys = Object.keys(obj1);\n    for (i = 0; i !== keys.length; i++) {\n        if (!c.hasOwnProperty(keys[i])) {\n            c[keys[i]] = obj1[keys[i]];\n        }\n    }\n\n    return c;\n};\n\n\n/* Capture the layout name; thanks express-hbs */\nvar rLayoutPattern = /{{!<\\s+([A-Za-z0-9\\._\\-\\/]+)\\s*}}/;\nvar rPartialPattern = /{{>\\s+([A-Za-z0-9\\._\\-\\/]+)\\s*}}/g;\n\n/**\n * file reader returning a thunk\n * @param filename {String} Name of file to read\n */\n\nvar read = function (filename) {\n    return new Promise(function (resolve, reject) {\n        fs.readFile(filename, {encoding: 'utf8'}, function (err, data) {\n            if (err) throw err;\n            resolve(data);\n        });\n    });\n};\n\n/**\n * @class MissingTemplateError\n * @param {String} message The error message\n * @param {Object} extra   The value of the template, relating to the error.\n */\nfunction MissingTemplateError(message, extra) {\n    Error.captureStackTrace(this, this.constructor);\n    this.name = this.constructor.name;\n    this.message = message;\n    this.extra = extra;\n};\n\nutil.inherits(MissingTemplateError, Error);\n\n/**\n * @class BadOptionsError\n * @param {String} message The error message\n * @param {Object} extra   Misc infomration.\n */\nfunction BadOptionsError(message, extra) {\n    Error.captureStackTrace(this, this.constructor);\n    this.name = this.constructor.name;\n    this.message = message;\n    this.extra = extra;\n};\n\nutil.inherits(BadOptionsError, Error);\n\n/**\n * expose default instance of `Hbs`\n */\n\nexports = module.exports = new Hbs();\n\n/**\n * expose method to create additional instances of `Hbs`\n */\n\nexports.create = function () {\n    return new Hbs();\n};\n\n\n/**\n * Create new instance of `Hbs`\n *\n * @api public\n */\n\nfunction Hbs() {\n    if (!(this instanceof Hbs)) {\n        return new Hbs();\n    }\n\n    this.handlebars = require('handlebars').create();\n\n    this.Utils = this.handlebars.Utils;\n    this.SafeString = this.handlebars.SafeString;\n}\n\n/**\n * Configure the instance.\n *\n * @api private\n */\n\nHbs.prototype.configure = function (options) {\n\n    var self = this;\n\n    if (!options.viewPath) {\n        throw new BadOptionsError('The option `viewPath` must be specified.');\n    }\n\n    // Attach options\n    options = options || {};\n    this.viewPath = options.viewPath || '';\n    this.handlebars = options.handlebars || this.handlebars;\n    this.templateOptions = options.templateOptions || {};\n    this.extname = options.extname || '.hbs';\n    this.partialsPath = options.partialsPath || '';\n    this.contentHelperName = options.contentHelperName || 'contentFor';\n    this.blockHelperName = options.blockHelperName || 'block';\n    this.defaultLayout = options.defaultLayout || '';\n    this.layoutsPath = options.layoutsPath || '';\n    this.locals = options.locals || {};\n\n    // Cache templates and layouts\n    this.cache = {};\n\n    this.blocks = {};\n\n    // block helper\n    this.registerHelper(this.blockHelperName, function (name, options) {\n        // instead of returning self.block(name), render the default content if no\n        // block is given\n        val = self.block(name);\n        if (val === '' && typeof options.fn === 'function') {\n            val = options.fn(this);\n        }\n\n        return val;\n    });\n\n    // contentFor helper\n    this.registerHelper(this.contentHelperName, function (name, options) {\n        return self.content(name, options, this);\n    });\n\n    return this;\n};\n\n/**\n * Middleware for koa\n *\n * @api public\n */\n\nHbs.prototype.middleware = function (options) {\n    this.configure(options);\n\n    var hbs = this;\n\n    if (hbs.partialsPath !== '') {\n        hbs.registerPartials();\n    }\n\n    return async function (ctx, next) {\n\n        ctx.render = async function (tpl, locals) {\n\n            var theme = '';\n            if (ctx.state.theme) {\n                theme = ctx.state.theme + '/';\n            }\n\n            var tplPath = hbs.getTemplatePath(theme + tpl),\n                template, rawTemplate, layoutTemplate, partials = [];\n\n            if (!tplPath) {\n                throw new MissingTemplateError('The template specified does not exist.', tplPath);\n            }\n\n            // allow absolute paths to be used\n            if (path.isAbsolute(tpl)) {\n                tplPath = tpl + hbs.extname;\n            }\n\n            locals = merge(ctx.state || {}, locals || {});\n            locals = merge(hbs.locals, locals);\n\n            // Load the template\n            rawTemplate = await read(tplPath);\n            hbs.cache[tpl] = {\n                template: hbs.handlebars.compile(rawTemplate)\n            };\n\n            // register template partials\n            var partial;\n            while ((partial = rPartialPattern.exec(rawTemplate)) != null) {\n                partials.push(partial[1] + hbs.extname);\n            }\n            await hbs.registerPartials(partials);\n\n            // Load layout if specified\n            if (typeof locals.layout !== 'undefined' || rLayoutPattern.test(rawTemplate)) {\n                var layout = locals.layout;\n\n                if (typeof layout === 'undefined') {\n                    layout = rLayoutPattern.exec(rawTemplate)[1];\n                }\n\n                if (layout !== false) {\n                    var rawLayout = await hbs.loadLayoutFile(layout);\n                    hbs.cache[tpl].layoutTemplate = hbs.handlebars.compile(rawLayout);\n                } else {\n                    hbs.cache[tpl].layoutTemplate = hbs.handlebars.compile('{{{body}}}');\n                }\n            }\n\n            template = hbs.cache[tpl].template;\n            layoutTemplate = hbs.cache[tpl].layoutTemplate;\n            if (!layoutTemplate) {\n                layoutTemplate = await hbs.getLayoutTemplate();\n            }\n\n            // Add the current koa context to templateOptions.data to provide access\n            // to the request within helpers.\n            if (!hbs.templateOptions.data) {\n                hbs.templateOptions.data = {};\n            }\n\n            hbs.templateOptions.data = merge(hbs.templateOptions.data, {koa: this});\n\n            // Run the compiled templates\n            locals.body = template(locals, hbs.templateOptions);\n            ctx.body = layoutTemplate(locals, hbs.templateOptions);\n        };\n\n        await next();\n    }\n};\n\n/**\n * Get layout path\n */\n\nHbs.prototype.getLayoutPath = function (layout) {\n    if (this.layoutsPath) {\n        return path.join(this.layoutsPath, layout + this.extname);\n    }\n\n    return path.join(this.viewPath, layout + this.extname);\n};\n\n/**\n * Lazy load default layout in cache.\n */\nHbs.prototype.getLayoutTemplate = async function () {\n    return await this.getLayout();\n}\n\n/**\n * Get a default layout. If none is provided, make a noop\n */\n\nHbs.prototype.getLayout = async function (layout) {\n    var hbs = this;\n\n    // Create a default layout to always use\n    if (!layout && !hbs.defaultLayout) {\n        return hbs.handlebars.compile('{{{body}}}');\n    }\n\n    // Compile the default layout if one not passed\n    if (!layout) {\n        layout = hbs.defaultLayout;\n    }\n\n    var layoutTemplate;\n    try {\n        var rawLayout = await hbs.loadLayoutFile(layout);\n        layoutTemplate = hbs.handlebars.compile(rawLayout);\n    } catch (err) {\n        console.error(err.stack);\n    }\n\n    return layoutTemplate;\n};\n\n/**\n * Load a layout file\n */\n\nHbs.prototype.loadLayoutFile = async function (layout) {\n    var hbs = this;\n\n    var file = hbs.getLayoutPath(layout);\n    return await read(file);\n};\n\n/**\n * Register helper to internal handlebars instance\n */\n\nHbs.prototype.registerHelper = function () {\n    this.handlebars.registerHelper.apply(this.handlebars, arguments);\n};\n\n/**\n * Register partial with internal handlebars instance\n */\n\nHbs.prototype.registerPartial = function () {\n    this.handlebars.registerPartial.apply(this.handlebars, arguments);\n};\n\n/**\n * Register directory of partials\n */\n\nHbs.prototype.registerPartials = async function (partials = []) {\n    var self = this;\n\n    var readdir = function (root) {\n        return new Promise(function (resolve, reject) {\n            glob('**/*' + self.extname, {\n                cwd: root,\n            }, function (err, files) {\n                if (err) throw err;\n                resolve(files);\n            });\n        });\n    }\n\n    try {\n        var partialsPath = self.partialsPath;\n        var resultList = [];\n        if (partials.length) {\n            resultList = partials;\n        } else {\n            resultList = await readdir(partialsPath);\n        }\n\n        var files = [];\n        var names = [];\n\n        if (!resultList.length) {\n            return;\n        }\n\n        // Generate list of files and template names\n        resultList.forEach(function (result, i) {\n            files.push(path.join(partialsPath, result));\n            names.push(result.slice(0, -1 * self.extname.length));\n        });\n\n        // Read all the partial from disk\n        // var partials = await files.map(read);\n        var partials = [];\n        for (var key in files) {\n            var partial = await read(files[key]);\n            partials.push(partial);\n        }\n\n        for (var i = 0; i !== partials.length; i++) {\n            self.registerPartial(names[i], partials[i]);\n        }\n    } catch (e) {\n        console.error('Error caught while registering partials');\n        console.error(e);\n    }\n};\n\nHbs.prototype.getTemplatePath = function getTemplatePath(tpl) {\n    var cache = (this.pathCache || (this.pathCache = {}));\n    if (cache[tpl])\n        return cache[tpl];\n\n    var tplPath = path.join(this.viewPath, tpl + this.extname);\n    try {\n        fs.statSync(tplPath);\n\n        cache[tpl] = tplPath;\n\n        return tplPath;\n    } catch (e) {\n        throw e;\n    }\n\n    return void 0;\n};\n\n/**\n * The contentFor helper delegates to here to populate block content\n */\n\nHbs.prototype.content = function (name, options, context) {\n    // fetch block\n    var block = this.blocks[name] || (this.blocks[name] = []);\n\n    // render block and save for layout render\n    block.push(options.fn(context));\n};\n\n/**\n * block helper delegates to this function to retreive content\n */\n\nHbs.prototype.block = function (name) {\n    // val = block.toString\n    var val = (this.blocks[name] || []).join('\\n');\n\n    // clear the block\n    this.blocks[name] = [];\n    return val;\n};\n"]}