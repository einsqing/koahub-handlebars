{"version":3,"sources":["../src/index.js"],"names":["fs","require","path","glob","util","merge","obj1","obj2","c","keys","i","length","hasOwnProperty","rLayoutPattern","read","filename","resolve","reject","readFile","encoding","err","data","MissingTemplateError","message","extra","Error","captureStackTrace","constructor","name","inherits","BadOptionsError","exports","module","Hbs","create","handlebars","Utils","SafeString","prototype","configure","options","self","viewPath","templateOptions","extname","partialsPath","contentHelperName","blockHelperName","defaultLayout","layoutsPath","locals","disableCache","partialsRegistered","cache","blocks","registerHelper","val","block","fn","content","middleware","render","createRenderer","ctx","next","getTheme","theme","state","hbs","tpl","tplPath","getTemplatePath","isAbsolute","registerPartials","rawTemplate","template","compile","layout","test","exec","loadLayoutFile","rawLayout","layoutTemplate","getLayoutTemplate","koa","body","getLayoutPath","join","cacheLayout","console","error","stack","file","apply","arguments","registerPartial","readdir","root","cwd","files","resultList","names","forEach","result","push","slice","partials","key","partial","pathCache","statSync","e","context"],"mappings":"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","file":"index.js","sourcesContent":["var fs = require('fs');\nvar path = require('path');\nvar glob = require('glob');\nvar util = require('util');\n\n/**\n * Shallow copy two objects into a new object\n *\n * Objects are merged from left to right. Thus, properties in objects further\n * to the right are preferred over those on the left.\n *\n * @param {object} obj1\n * @param {object} obj2\n * @returns {object}\n * @api private\n */\n\nvar merge = function (obj1, obj2) {\n    var c = {};\n    var keys = Object.keys(obj2);\n    for (var i = 0; i !== keys.length; i++) {\n        c[keys[i]] = obj2[keys[i]];\n    }\n\n    keys = Object.keys(obj1);\n    for (i = 0; i !== keys.length; i++) {\n        if (!c.hasOwnProperty(keys[i])) {\n            c[keys[i]] = obj1[keys[i]];\n        }\n    }\n\n    return c;\n};\n\n\n/* Capture the layout name; thanks express-hbs */\nvar rLayoutPattern = /{{!<\\s+([A-Za-z0-9\\._\\-\\/]+)\\s*}}/;\n\n/**\n * file reader returning a thunk\n * @param filename {String} Name of file to read\n */\n\nvar read = function (filename) {\n    return new Promise(function (resolve, reject) {\n        fs.readFile(filename, {encoding: 'utf8'}, function (err, data) {\n            if (err) throw err;\n            resolve(data);\n        });\n    });\n};\n\n/**\n * @class MissingTemplateError\n * @param {String} message The error message\n * @param {Object} extra   The value of the template, relating to the error.\n */\nfunction MissingTemplateError(message, extra) {\n    Error.captureStackTrace(this, this.constructor);\n    this.name = this.constructor.name;\n    this.message = message;\n    this.extra = extra;\n};\n\nutil.inherits(MissingTemplateError, Error);\n\n/**\n * @class BadOptionsError\n * @param {String} message The error message\n * @param {Object} extra   Misc infomration.\n */\nfunction BadOptionsError(message, extra) {\n    Error.captureStackTrace(this, this.constructor);\n    this.name = this.constructor.name;\n    this.message = message;\n    this.extra = extra;\n};\n\nutil.inherits(BadOptionsError, Error);\n\n/**\n * expose default instance of `Hbs`\n */\n\nexports = module.exports = new Hbs();\n\n/**\n * expose method to create additional instances of `Hbs`\n */\n\nexports.create = function () {\n    return new Hbs();\n};\n\n\n/**\n * Create new instance of `Hbs`\n *\n * @api public\n */\n\nfunction Hbs() {\n    if (!(this instanceof Hbs)) {\n        return new Hbs();\n    }\n\n    this.handlebars = require('handlebars').create();\n\n    this.Utils = this.handlebars.Utils;\n    this.SafeString = this.handlebars.SafeString;\n}\n\n/**\n * Configure the instance.\n *\n * @api private\n */\n\nHbs.prototype.configure = function (options) {\n\n    var self = this;\n\n    if (!options.viewPath) {\n        throw new BadOptionsError('The option `viewPath` must be specified.');\n    }\n\n    // Attach options\n    options = options || {};\n    this.viewPath = options.viewPath || '';\n    this.handlebars = options.handlebars || this.handlebars;\n    this.templateOptions = options.templateOptions || {};\n    this.extname = options.extname || '.hbs';\n    this.partialsPath = options.partialsPath || '';\n    this.contentHelperName = options.contentHelperName || 'contentFor';\n    this.blockHelperName = options.blockHelperName || 'block';\n    this.defaultLayout = options.defaultLayout || '';\n    this.layoutsPath = options.layoutsPath || '';\n    this.locals = options.locals || {};\n    this.disableCache = options.disableCache || true;\n    this.partialsRegistered = false;\n\n    // Cache templates and layouts\n    this.cache = {};\n\n    this.blocks = {};\n\n    // block helper\n    this.registerHelper(this.blockHelperName, function (name, options) {\n        // instead of returning self.block(name), render the default content if no\n        // block is given\n        val = self.block(name);\n        if (val === '' && typeof options.fn === 'function') {\n            val = options.fn(this);\n        }\n\n        return val;\n    });\n\n    // contentFor helper\n    this.registerHelper(this.contentHelperName, function (name, options) {\n        return self.content(name, options, this);\n    });\n\n    return this;\n};\n\n/**\n * Middleware for koa\n *\n * @api public\n */\n\nHbs.prototype.middleware = function (options) {\n    this.configure(options);\n\n    var render = this.createRenderer();\n\n    return async function (ctx, next) {\n        ctx.render = render;\n        await next();\n    }\n};\n\n/**\n *\n * set theme\n */\nHbs.prototype.getTheme = function () {\n    var theme = '';\n    if (ctx.state.theme) {\n        theme = ctx.state.theme + '/';\n    }\n\n    return theme;\n}\n/**\n * Create a render generator to be attached to koa context\n */\n\nHbs.prototype.createRenderer = function () {\n    var hbs = this;\n\n    return async function (tpl, locals) {\n        var theme = hbs.getTheme();\n        var tplPath = hbs.getTemplatePath(theme + tpl),\n            template, rawTemplate, layoutTemplate;\n\n        if (!tplPath) {\n            throw new MissingTemplateError('The template specified does not exist.', tplPath);\n        }\n\n        // allow absolute paths to be used\n        if (path.isAbsolute(tpl)) {\n            tplPath = tpl + hbs.extname;\n        }\n\n        locals = merge(ctx.state || {}, locals || {});\n        locals = merge(hbs.locals, locals);\n\n        // Initialization... move these actions into another function to remove\n        // unnecessary checks\n        if (hbs.disableCache || !hbs.partialsRegistered && hbs.partialsPath !== '') {\n            await hbs.registerPartials();\n        }\n\n        // Load the template\n        if (hbs.disableCache || !hbs.cache[tpl]) {\n            rawTemplate = await read(tplPath);\n            hbs.cache[tpl] = {\n                template: hbs.handlebars.compile(rawTemplate)\n            };\n\n            // Load layout if specified\n            if (typeof locals.layout !== 'undefined' || rLayoutPattern.test(rawTemplate)) {\n                var layout = locals.layout;\n\n                if (typeof layout === 'undefined') {\n                    layout = rLayoutPattern.exec(rawTemplate)[1];\n                }\n\n                if (layout !== false) {\n                    var rawLayout = await hbs.loadLayoutFile(layout);\n                    hbs.cache[tpl].layoutTemplate = hbs.handlebars.compile(rawLayout);\n                } else {\n                    hbs.cache[tpl].layoutTemplate = hbs.handlebars.compile('{{{body}}}');\n                }\n            }\n        }\n\n        template = hbs.cache[tpl].template;\n        layoutTemplate = hbs.cache[tpl].layoutTemplate;\n        if (!layoutTemplate) {\n            layoutTemplate = await hbs.getLayoutTemplate();\n        }\n\n        // Add the current koa context to templateOptions.data to provide access\n        // to the request within helpers.\n        if (!hbs.templateOptions.data) {\n            hbs.templateOptions.data = {};\n        }\n\n        hbs.templateOptions.data = merge(hbs.templateOptions.data, {koa: this});\n\n        // Run the compiled templates\n        locals.body = template(locals, hbs.templateOptions);\n        ctx.body = layoutTemplate(locals, hbs.templateOptions);\n    };\n};\n\n/**\n * Get layout path\n */\n\nHbs.prototype.getLayoutPath = function (layout) {\n    if (this.layoutsPath) {\n        return path.join(this.layoutsPath, layout + this.extname);\n    }\n\n    return path.join(this.viewPath, layout + this.extname);\n};\n\n/**\n * Lazy load default layout in cache.\n */\nHbs.prototype.getLayoutTemplate = async function () {\n    if (this.disableCache || !this.layoutTemplate) {\n        this.layoutTemplate = await this.cacheLayout();\n    }\n    return this.layoutTemplate;\n}\n\n/**\n * Get a default layout. If none is provided, make a noop\n */\n\nHbs.prototype.cacheLayout = async function (layout) {\n    var hbs = this;\n\n    // Create a default layout to always use\n    if (!layout && !hbs.defaultLayout) {\n        return hbs.handlebars.compile('{{{body}}}');\n    }\n\n    // Compile the default layout if one not passed\n    if (!layout) {\n        layout = hbs.defaultLayout;\n    }\n\n    var layoutTemplate;\n    try {\n        var rawLayout = await hbs.loadLayoutFile(layout);\n        layoutTemplate = hbs.handlebars.compile(rawLayout);\n    } catch (err) {\n        console.error(err.stack);\n    }\n\n    return layoutTemplate;\n};\n\n/**\n * Load a layout file\n */\n\nHbs.prototype.loadLayoutFile = async function (layout) {\n    var hbs = this;\n\n    var file = hbs.getLayoutPath(layout);\n    return await read(file);\n};\n\n/**\n * Register helper to internal handlebars instance\n */\n\nHbs.prototype.registerHelper = function () {\n    this.handlebars.registerHelper.apply(this.handlebars, arguments);\n};\n\n/**\n * Register partial with internal handlebars instance\n */\n\nHbs.prototype.registerPartial = function () {\n    this.handlebars.registerPartial.apply(this.handlebars, arguments);\n};\n\n/**\n * Register directory of partials\n */\n\nHbs.prototype.registerPartials = async function () {\n    var self = this;\n\n    var readdir = function (root) {\n        return new Promise(function (resolve, reject) {\n            glob('**/*' + self.extname, {\n                cwd: root,\n            }, function (err, files) {\n                if (err) throw err;\n                resolve(files);\n            });\n        });\n    }\n\n    try {\n        var partialsPath = self.partialsPath;\n        var resultList = await readdir(partialsPath);\n        var files = [];\n        var names = [];\n\n        if (!resultList.length) {\n            return;\n        }\n\n        // Generate list of files and template names\n        resultList.forEach(function (result, i) {\n            files.push(path.join(partialsPath, result));\n            names.push(result.slice(0, -1 * self.extname.length));\n        });\n\n        // Read all the partial from disk\n        // var partials = await files.map(read);\n        var partials = [];\n        for (var key in files) {\n            var partial = await read(files[key]);\n            partials.push(partial);\n        }\n\n        for (var i = 0; i !== partials.length; i++) {\n            self.registerPartial(names[i], partials[i]);\n        }\n\n        self.partialsRegistered = true;\n    } catch (e) {\n        console.error('Error caught while registering partials');\n        console.error(e);\n    }\n};\n\nHbs.prototype.getTemplatePath = function getTemplatePath(tpl) {\n    var cache = (this.pathCache || (this.pathCache = {}));\n    if (cache[tpl])\n        return cache[tpl];\n\n    var tplPath = path.join(this.viewPath, tpl + this.extname);\n    try {\n        fs.statSync(tplPath);\n        if (!this.disableCache)\n            cache[tpl] = tplPath;\n\n        return tplPath;\n    } catch (e) {\n        throw e;\n    }\n\n    return void 0;\n};\n\n/**\n * The contentFor helper delegates to here to populate block content\n */\n\nHbs.prototype.content = function (name, options, context) {\n    // fetch block\n    var block = this.blocks[name] || (this.blocks[name] = []);\n\n    // render block and save for layout render\n    block.push(options.fn(context));\n};\n\n/**\n * block helper delegates to this function to retreive content\n */\n\nHbs.prototype.block = function (name) {\n    // val = block.toString\n    var val = (this.blocks[name] || []).join('\\n');\n\n    // clear the block\n    this.blocks[name] = [];\n    return val;\n};\n"]}